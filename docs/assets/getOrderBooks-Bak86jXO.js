import{c as m,e as u,h as I,o as y,ah as x}from"./index-Dxu4lnfn.js";function T(n=m("BTCUSDT"),s=.1){const d=x(s),t=m({bids:u,asks:u,buffer:u,lastUpdateId:0,symbolPair:""}),o=m(Date.now());return I(()=>{const a=n.get();t.set({bids:u,asks:u,buffer:u,symbolPair:a,lastUpdateId:0}),o.get();const i=new WebSocket(`wss://stream.binance.com:9443/ws/${a.toLowerCase()}@depth`);function f(){o.set(Date.now())}async function l(){try{const c=new URLSearchParams;c.set("url",`https://api.binance.com/api/v3/depth?symbol=${a}&limit=1000`);const e=await(await fetch(`https://silent-union-5853.wangyang2010344-dae.workers.dev?${c.toString()}`)).json(),r=t.get();if(r.symbolPair!=a)return;t.set({...r,lastUpdateId:e.lastUpdateId,asks:e.asks.map(h),bids:e.bids.map(h)})}catch(c){console.log("err",c),f()}}return i.addEventListener("message",c=>{const b=JSON.parse(c.data),e=t.get();if(e.symbolPair==a&&e.symbolPair==b.s)if(e.lastUpdateId){let r;if(e.buffer.length){const g=e.lastUpdateId+1;let p=e.buffer.findIndex(k=>k.U<=g&&k.u>=g);if(p<0){t.set({...e,buffer:[...e.buffer,b]});return}for(r={...e,asks:[...e.asks],bids:[...e.bids]},r.buffer=u,r.lastUpdateId=e.buffer[p].U-1;r&&p<e.buffer.length;){const k=e.buffer[p];r=w(k,r),p++}if(!r){console.warn("Orderbook 同步失败"),f();return}}else r={...e,asks:[...e.asks],bids:[...e.bids]};if(r=w(b,r),!r){console.warn("Orderbook 同步失败",b,r),f();return}O(r),t.set(r)}else e.buffer.length||l(),t.set({...e,buffer:[...e.buffer,b]}),i.close()}),function(){i.close()}}),{coinSymbolPair:n,currentOrderBook:y(function(){const a=t.get(),i=d();return{...a,asks:U(a.asks,i).sort((f,l)=>f[0]-l[0]).slice(0,1e3),bids:U(a.bids,i).sort((f,l)=>l[0]-f[0]).slice(0,1e3)}})}}function U(n,s){return n.reduce((d,[t,o])=>{const a=Math.round(t/s)*s,i=d.find(f=>f[0]==a);return i?i[1]=i[1]+o:d.push([a,o]),d},[])}function w(n,s){if(n.U==s.lastUpdateId+1)return n.b.forEach(d=>{const t=h(d),o=s.bids.findIndex(a=>a[0]==t[0]);o<0?s.bids.push(t):s.bids[o]=t}),n.a.forEach(d=>{const t=h(d),o=s.bids.findIndex(a=>a[0]==t[0]);o<0?s.asks.push(t):s.asks[o]=t}),s.lastUpdateId=n.u,s}function O(n){n.bids=n.bids.filter(s=>s[1]),n.asks=n.asks.filter(s=>s[1])}function h(n){return n.map(Number)}export{T as hookOrderBooks};
