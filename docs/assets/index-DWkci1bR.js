import{bs as j,l as V,P as D,k as W,Q as z,aM as U}from"./index-Dxu4lnfn.js";import{g as q,r as I,T as F,h as N}from"./hookThreeView-mCM5t74t.js";import{f as T,l as X,g as Y,a as Q}from"./getBodies-D7FHF5xD.js";import"./three.module-CG7OlevV.js";import{cC as Z,H as M,j as B,cn as J,cD as K,a2 as E,a5 as $,cE as ee,f as te,cF as ae,cG as ne,bW as se,S as re,bu as ie,V as _,an as oe,cw as ce,cy as le,ck as he,h as pe,ax as ge,bM as de,ap as ue,cg as fe}from"./three.core-DinwzvY0.js";import me from"./getLayer-Cggnw2wx.js";const we=""+new URL("san_giuseppe_bridge_2k-DZwWv-1U.jpg",import.meta.url).href,ye=""+new URL("spruit_sunrise_2k.hdr-BSUBzU4I.jpg",import.meta.url).href,Re=Array(1024).fill(0).map((u,e)=>Math.pow(e/255*.9478672986+.0521327014,2.4));class be extends Z{constructor(e){super(e),this.type=M}setDataType(e){return this.type=e,this}parse(e,r){const c={version:null,baseRenditionIsHDR:null,gainMapMin:null,gainMapMax:null,gamma:null,offsetSDR:null,offsetHDR:null,hdrCapacityMin:null,hdrCapacityMax:null},h=new TextDecoder,i=new DataView(e);let a=0;const t=[];for(;a<i.byteLength;){const n=i.getUint8(a);if(n===255){const o=i.getUint8(a+1);[216,224,225,226].includes(o)?(t.push({sectionType:o,section:[n,o],sectionOffset:a+2}),a+=2):(t[t.length-1].section.push(n,o),a+=2)}else t[t.length-1].section.push(n),a++}let s,d;for(let n=0;n<t.length;n++){const{sectionType:o,section:p,sectionOffset:g}=t[n];if(o!==224){if(o===225)this._parseXMPMetadata(h.decode(new Uint8Array(p)),c);else if(o===226){const l=new DataView(new Uint8Array(p.slice(2)).buffer);if(l.getUint32(2,!1)===1297106432){const m=l.getUint32(6)===1229531648,w=60,b=l.getUint32(w,m),L=l.getUint32(w+4,m),f=l.getUint32(w+16,m),H=l.getUint32(w+20,m)+g+6;s=new Uint8Array(i.buffer,L,b),d=new Uint8Array(i.buffer,H,f)}}}}if(!c.version)throw new Error("THREE.UltraHDRLoader: Not a valid UltraHDR image");if(s&&d)this._applyGainmapToSDR(c,s,d,(n,o,p)=>{r({width:o,height:p,data:n,format:B,type:this.type})},n=>{throw new Error(n)});else throw new Error("THREE.UltraHDRLoader: Could not parse UltraHDR images")}load(e,r,c,h){const i=new J(this.type===M?new Uint16Array:new Float32Array,0,0,B,this.type,K,E,E,$,ee,1,te);i.generateMipmaps=!0,i.flipY=!0;const a=new ae(this.manager);return a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setPath(this.path),a.setWithCredentials(this.withCredentials),a.load(e,t=>{try{this.parse(t,s=>{i.image={data:s.data,width:s.width,height:s.height},i.needsUpdate=!0,r&&r(i,s)})}catch(s){h&&h(s),console.error(s)}},c,h),i}_parseXMPMetadata(e,r){const h=new DOMParser().parseFromString(e.substring(e.indexOf("<"),e.lastIndexOf(">")+1),"text/xml"),[i]=h.getElementsByTagName("Container:Directory");if(!i){const[a]=h.getElementsByTagName("rdf:Description");r.version=a.getAttribute("hdrgm:Version"),r.baseRenditionIsHDR=a.getAttribute("hdrgm:BaseRenditionIsHDR")==="True",r.gainMapMin=parseFloat(a.getAttribute("hdrgm:GainMapMin")||0),r.gainMapMax=parseFloat(a.getAttribute("hdrgm:GainMapMax")||1),r.gamma=parseFloat(a.getAttribute("hdrgm:Gamma")||1),r.offsetSDR=parseFloat(a.getAttribute("hdrgm:OffsetSDR")/(1/64)),r.offsetHDR=parseFloat(a.getAttribute("hdrgm:OffsetHDR")/(1/64)),r.hdrCapacityMin=parseFloat(a.getAttribute("hdrgm:HDRCapacityMin")||0),r.hdrCapacityMax=parseFloat(a.getAttribute("hdrgm:HDRCapacityMax")||1)}}_srgbToLinear(e){return e/255<.04045?e/255*.0773993808:e<1024?Re[~~e]:Math.pow(e/255*.9478672986+.0521327014,2.4)}_applyGainmapToSDR(e,r,c,h,i){const a=t=>new Promise((s,d)=>{const n=document.createElement("img");n.onload=()=>{const o={width:n.naturalWidth,height:n.naturalHeight,source:n};URL.revokeObjectURL(n.src),s(o)},n.onerror=()=>{URL.revokeObjectURL(n.src),d()},n.src=URL.createObjectURL(new Blob([t],{type:"image/jpeg"}))});Promise.all([a(r),a(c)]).then(([t,s])=>{const d=t.width/t.height,n=s.width/s.height;if(d!==n){i("THREE.UltraHDRLoader Error: Aspect ratio mismatch between SDR and Gainmap images");return}const o=document.createElement("canvas"),p=o.getContext("2d",{willReadFrequently:!0,colorSpace:"srgb"});o.width=t.width,o.height=t.height,p.drawImage(s.source,0,0,s.width,s.height,0,0,t.width,t.height);const g=p.getImageData(0,0,t.width,t.height,{colorSpace:"srgb"});p.drawImage(t.source,0,0);const l=p.getImageData(0,0,t.width,t.height,{colorSpace:"srgb"});let y;this.type===M?y=new Uint16Array(l.data.length).fill(23544):y=new Float32Array(l.data.length).fill(255);const m=Math.sqrt(Math.pow(1.8,e.hdrCapacityMax)),w=(Math.log2(m)-e.hdrCapacityMin)/(e.hdrCapacityMax-e.hdrCapacityMin),b=Math.min(Math.max(w,0),1),L=e.gamma===1;for(let f=0;f<l.data.length;f+=4){const H=f/4%t.width,P=Math.floor(f/4/t.width);for(let R=0;R<3;R++){const v=l.data[f+R],G=(P*t.width+H)*4+R,A=g.data[G]/255,C=L?A:Math.pow(A,1/e.gamma),x=e.gainMapMin*(1-C)+e.gainMapMax*C,k=(v+e.offsetSDR)*(x*b===0?1:Math.pow(2,x*b))-e.offsetHDR,S=Math.min(Math.max(this._srgbToLinear(k),0),65504);y[f+R]=this.type===M?ne.toHalfFloat(S):S}}h(y,t.width,t.height)}).catch(()=>{throw new Error("THREE.UltraHDRLoader Error: Could not parse UltraHDR images")})}}const O=Object.assign({"./envs/san_giuseppe_bridge_2k.jpg":we,"./envs/spruit_sunrise_2k.hdr.jpg":ye});console.log("envs",O);function Se(){const u=j(Promise.all([T.init(),X()]));V(u.get,function(e){if(e?.type=="success"){const r={x:0,y:0,z:0},c=new T.World(r),h=q(D.width,D.height);I({camera:h,width:D.width,height:D.height,args:{antialias:!0},render(i){const{renderer:a,hookAnimationLoop:t}=F.consume();a.toneMapping=se,a.outputColorSpace=re,N().enableDamping=!0,new be().load(O["./envs/san_giuseppe_bridge_2k.jpg"],g=>{g.mapping=ie,i.environment=g});const d=100,n=[];for(let g=0;g<d;g++){const l=Y(c);n.push(l),i.add(l.mesh)}const o=Q(c);i.add(o.mesh);const p=new _(0,0,0);W(z(window,"pointermove",g=>{p.x=g.clientX/window.innerWidth*2-1,p.y=-(g.clientY/window.innerHeight)*2+1})),t(g=>{c.step(),o.update(p),n.forEach(l=>l.update())}),Ue(),De(),Me()}})}})}function De(){const{camera:u,hookAnimationLoop:e}=F.consume(),r=new he,c=new pe(0,0),h=new _(0,0,0),i=new ge(48,48,48,48),a=new de({wireframe:!0,color:65280,transparent:!0,opacity:0}),t=new ue(i,a);t.position.set(0,0,.2),U(t);const s=new _;e(()=>{u.getWorldDirection(s),s.multiplyScalar(-1),t.lookAt(s),r.setFromCamera(c,u);const d=r.intersectObjects([t],!1);d.length>0&&h.copy(d[0].point)})}function Me(){const u=new fe(48127,11141375);u.intensity=.2,U(u)}function Ue(){const u=me({hue:.6,numSprites:8,opacity:.2,radius:10,size:24,z:-10.5});U(u);const e=new oe,r=new ce({size:.035,vertexColors:!0}),c=new le(e,r);U(c)}export{Se as default};
