import{l as list,a as KVar,s as success,f as fail,b as streamAppendStream,c as streamBindGoal,e as extendSubsitution,d as findVarDefine}from"./kanren-DfUmp-DM.js";import{a$ as manyMatch,bB as skipMatchEnd,bC as orMatch,bD as isChinese,bE as isNumber,bF as isLowerEnglish,bG as isUpperEnglish,bH as Que,a_ as ruleGetString$1,bI as or,x as emptyFun,bJ as parseGet,bK as matchAnyString,bL as andMatch,bM as ruleStrBetween,bN as whiteSpaceMatch,bO as matchCharIn,bP as stringToCharCode,bQ as orMatchEmpty,bR as skipAnyString,bS as ruleStrBetweenGet1,bT as isFloat,bU as parseSkip,aZ as ruleStrBetweenGet,bV as isParseSuccess}from"./index-DzjyJcX9.js";var __defProp=Object.defineProperty,__defNormalProp=(e,t,n)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,__publicField=(e,t,n)=>(__defNormalProp(e,t+"",n),n);function parseInfixBB(e,t,n){const r=e(),i=parsePrefix(t,e,n);return{first:r,exts:i}}function parseInfixNode(e){return function(){return parseGet(e.match,(t,n)=>({value:e.get(t,n),begin:t.i,end:n.i,errors:[]}))}}function parseInfixStr(e){return()=>parseGet(matchAnyString(e),(t,n)=>({value:t.content.slice(t.i,n.i),begin:t.i,end:n.i}))}function parsePrefix(e,t,n){const r=[];for(;or([()=>{n();const s=or(e.map(a=>typeof a=="string"?parseInfixStr(a):parseInfixNode(a)));n();const o=t();return r.push({infix:s,value:o}),!0},emptyFun],`infix:${e.map(s=>typeof s=="string"?s:s.display).join(" ")}`););return r}function parseInfixBLeft(e,t,n,r){const{first:i,exts:s}=parseInfixBB(e,t,n);let o=i;for(let a=0;a<s.length;a++){const u=s[a];o=r(u.infix,o,u.value)}return o}function parseInfixBRight(e,t,n,r){const{first:i,exts:s}=parseInfixBB(e,t,n);if(s.length){let{value:o,infix:a}=s[s.length-1],u=o;for(let l=s.length-2;l>-1;l--){const c=s[l];u=r(a,c.value,u),a=c.infix}return u=r(a,i,u),u}return i}function parseInfix(e,t,n,r){if(!e)return n();const i=e.left,s=()=>parseInfix(e.right,t,n,r);return Array.isArray(i)?parseInfixBLeft(s,i,t,r):parseInfixBRight(s,i.values,t,r)}function infixRightNeedQuote(e,t,n){return e>t?!0:e<t?!1:!!n}function manageInfixLib(e,t,n){const r=[],i=n.match;for(let a=0;a<t;a++){const u=e[a],l=Array.isArray(u)?u:u.values;for(let c=0;c<l.length;c++){const f=l[c];typeof f=="string"&&i(new Que(f))&&r.push(f)}}const s=e[t],o=Array.isArray(s)?s:s.values;for(const a of o)typeof a=="string"&&i(new Que(a))&&console.warn("同极包含可覆盖元素",a);return r.length?{...n,match(a){const u=i(a);if(u){const l=ruleGetString$1(a,u);if(r.includes(l))return}return u}}:n}function buildOneInfix(e,t,n){return e.map((r,i)=>typeof r=="string"?r:manageInfixLib(t,n,r))}function buildInfixLibArray(e){return e.map((t,n)=>Array.isArray(t)?buildOneInfix(t,e,n):{...t,values:buildOneInfix(t.values,e,n)})}function buildInfix(e,t,n,r){const i=buildInfixLibArray(e);function s(){return or([n,()=>{skipAnyString("("),t();const c=a();return t(),skipAnyString(")"),c}],"end-node")}const o=list(...i);function a(){return parseInfix(o,t,s,r)}function u(l){for(let c=i.length-1;c>-1;c--){const f=i[c];let m=!Array.isArray(f);const g=Array.isArray(f)?f:f.values;for(let p=0;p<g.length;p++){const h=g[p];if(h==l)return[c,l,m];if(typeof h=="object"&&h.match(new Que(l)))return[c,h.stringify(l),m]}}throw new Error("unfind the infix order")}return{parseNode:a,parseSentence(){t();let l=a();return t(),skipMatchEnd(),l},getInfixOrder:u}}function isInfixNode(e){return e.type=="infix"}function endNodeToToken(e,t,n,r){isInfixNode(e)?(endNodeToToken(e.left,t,n,r),t.push(r({value:e.infix.value,begin:e.infix.begin,end:e.infix.end})),endNodeToToken(e.right,t,n,r)):t.push(n(e))}function endNotFillToToken(e,t,n){return function(r,i){const s=[];endNodeToToken(r,s,e,t);let o=0;for(;o<s.length-1;){const l=s[o],c=s[o+1];l.end!=c.begin?(s.splice(o+1,0,n({value:i.slice(l.end,c.begin),begin:l.end,end:c.begin})),o=o+2):o=o+1}const a=s[0];a&&a.begin!=0&&s.unshift(n({value:i.slice(0,a.begin),begin:0,end:a.begin}));const u=s.at(-1);return u&&u.end!=i.length&&s.push(n({value:i.slice(u.end,i.length),begin:u.end,end:i.length})),s}}class VarPool{constructor(t){__publicField(this,"pool",new Map),this.parent=t}size(){return this.pool.size}get(t,n){if(t=="_")return KVar.create();let r=this.pool.get(t);if(!n&&!r){let i=this.parent;for(;i&&!r;)r=i.pool.get(t),i=i.parent}return r||(r=KVar.create(),this.pool.set(t,r)),r}forEach(t){this.pool.forEach(t)}}const matchCommonExt=manyMatch(orMatch(isUpperEnglish.matchCharBetween(),isLowerEnglish.matchCharBetween(),isNumber.matchCharBetween(),isChinese.matchCharBetween())),symbolRule=andMatch(orMatch(isLowerEnglish.matchCharBetween(),isChinese.matchCharBetween(26576)),matchCommonExt),varRule=andMatch(orMatch(isUpperEnglish.matchCharBetween(),matchAnyString("某"),matchAnyString("_")),matchCommonExt);function ruleGetNumber(){return parseGet(isFloat,function(e,t){const n=e.content.slice(e.i,t.i);return{type:"number",begin:e.i,end:t.i,errors:[],value:Number(n),originalValue:n}},"number")}function ruleGetString(){const[e,t,n]=ruleStrBetweenGet1(39),r=t.content.slice(t.i,n.i);return{type:"string",value:e,originalValue:r,begin:t.i,end:n.i}}const ruleComment=ruleStrBetween(34),ruleSkipWhiteOrComment=manyMatch(orMatch(ruleComment,whiteSpaceMatch)),ruleSkipWhiteOrCommentMin1=manyMatch(orMatch(ruleComment,whiteSpaceMatch),1);function skipWhiteOrComment(e){e?parseSkip(ruleSkipWhiteOrCommentMin1):parseSkip(ruleSkipWhiteOrComment)}function ruleGetSymbol$1(){return parseGet(symbolRule,function(e,t){const n=e.content.slice(e.i,t.i);return{type:"symbol",begin:e.i,end:t.i,errors:[],value:n}},"symbol")}function ruleGetVar(){return parseGet(varRule,function(e,t){const n=e.content.slice(e.i,t.i);return{type:"var",begin:e.i,end:t.i,errors:[],value:n}},"var")}const nc=39,matchBetween={match:ruleStrBetween(nc),get(e,t){const n=ruleGetString$1(e,t),r=ruleStrBetweenGet(nc)(new Que(n));if(isParseSuccess(r)&&r.end.i==n.length)return r.value;throw r},stringify(e){return` '${e.replace(/`/g,"\\`")}' `},display:"anyMatch~"},specialChar="~`!@#$^&?<>|:{}=+-*/",specialMatchRule=manyMatch(matchCharIn(...stringToCharCode(specialChar)),1),specialMatch={match:specialMatchRule,get(e,t){return ruleGetString$1(e,t)},stringify(e){return e},display:"specialMatch"},matchSymbolOrSpecial={match:andMatch(symbolRule,orMatchEmpty(specialMatchRule)),get(e,t){return ruleGetString$1(e,t)},stringify(e){return` ${e} `},display:"symbolMatch"},infixLibArray$1=[[";"],[":-"],[","],["="],[matchBetween,specialMatch,matchSymbolOrSpecial],["+","-"],["*","/","%"]],{getInfixOrder:getInfixOrder$1}=buildInfix(infixLibArray$1,skipWhiteOrComment,()=>or([ruleGetVar,ruleGetString,ruleGetSymbol$1,ruleGetNumber]),(e,t,n)=>({type:"infix",infix:e,left:t,right:n}));class IPair{constructor(t,n,r){this.type=t,this.left=n,this.right=r}}function walk(e,t){if(e instanceof KVar){const n=findVarDefine(e,t);return n?walk(n.right,t):e}else return e instanceof IPair?new IPair(e.type,walk(e.left,t),walk(e.right,t)):e}function baseUnify(e,t,n){if(e=walk(e,n),t=walk(t,n),e==t)return[!0,n];if(e instanceof KVar)return e.equals(t)?[!0,n]:[!0,extendSubsitution(e,t,n)];if(t instanceof KVar)return t.equals(e)?[!0,n]:[!0,extendSubsitution(t,e,n)];if(e instanceof IPair&&t instanceof IPair&&e.type==t.type){const[r,i]=baseUnify(e.left,t.left,n);if(r)return baseUnify(e.right,t.right,i)}return[!1,null]}function toUnify(e,t,n){const[r,i]=baseUnify(e,t,n);return r?success(i):null}function walkWithSet(e,t,n){return e=walk(e,t),findSub(e,n),e}function findSub(e,t){e instanceof IPair?(findSub(e.left,t),findSub(e.right,t)):e instanceof KVar&&t.add(e)}function topEvalExp(e,t,n){const r=new Set,i=walkWithSet(n,e,r);return streamBindGoal(toEvalRules(t,i,t),function(s){let o=e;return r.forEach(a=>{const u=walk(a,s);a.equals(u)||(o=extendSubsitution(a,u,o))}),success(o)})}function toEvalRules(e,t,n){if(e){const r=e.left,i=e.right;return streamAppendStream(r(t,n),function(){return toEvalRules(i,t,n)})}return null}function infixValue(e,t,n){return new IPair(t,e,n)}function innerStringify(e,t=-1,n){if(e instanceof IPair){const[r,i,s]=getInfixOrder$1(e.type),o=innerStringify(e.left,r,s),a=innerStringify(e.right,r,!s),u=infixRightNeedQuote(t,r,n),l=`${o}${i}${a}`;return u?`(${l})`:l}return e+""}function stringify(e){return innerStringify(e,-1)}function cloneIType(e,t){return e instanceof IPair?infixValue(cloneIType(e.left,t),e.type,cloneIType(e.right,t)):e instanceof KVar?t.get(e.flag):e}function toCustomRule(e,t){return(n,r)=>{const i=new VarPool,s=cloneIType(e,i),[o,a]=baseUnify(s,n,null);if(o){const u=success(a);return t?streamBindGoal(u,function(l){const c=cloneIType(t,i);return topEvalExp(l,r,c)}):u}return fail()}}list((e,t)=>e instanceof IPair&&e.type==","?streamBindGoal(topEvalExp(null,t,e.left),function(n){return topEvalExp(n,t,e.right)}):null,(e,t)=>e instanceof IPair&&e.type==";"?streamAppendStream(topEvalExp(null,t,e.left),function(){return topEvalExp(null,t,e.right)}):null,(e,t)=>e instanceof IPair&&e.type=="not"&&e.right=="true"?topEvalExp(null,t,e.left)?fail():success(null):null,(e,t)=>e instanceof IPair&&e.type=="queryIn"&&e.right=="global"?topEvalExp(null,t,e.left):null,(exp,topRules)=>{if(exp instanceof IPair&&exp.type=="jsEval"){const left=exp.left;if(typeof left=="string")try{const out=eval(left);return toUnify(out,exp.right,null)}catch(e){}}return null},(e,t)=>e instanceof IPair&&e.type=="write"?(console.log(e.left,stringify(e.right)),success(null)):null,e=>{if(e instanceof IPair&&e.type=="isTypeSimple"){const t=e.left;let n="";return t instanceof IPair?n="pair":t instanceof KVar?n="var":n=typeof t,toUnify(n,e.right,null)}return null},e=>{if(e instanceof IPair&&e.type=="isType"){const t=getDeepType(e.left);return toUnify(t,e.right,null)}return null},e=>e instanceof IPair&&e.type=="=="?toUnify(e.left,e.right,null):null,(e,t)=>{if(e instanceof IPair&&e.type=="apply"){const n=e.left;return orReturnStream(n,e.right,t)}return null},(e,t)=>{if(e instanceof IPair&&e.type.startsWith("都")){const n=toAllExp(e.left,e.type.slice(1),e.right);return topEvalExp(null,t,n)}return null});function toAllExp(e,t,n){return e instanceof IPair&&e.type==","?infixValue(toAllExp(e.left,t,n),",",infixValue(e.right,t,n)):infixValue(e,t,n)}function orReturnStream(e,t,n){return e instanceof IPair&&e.type==";"?streamAppendStream(orReturnStream(e.left,t,n),()=>getOneReturn(e.right,t,n)):getOneReturn(e,t,n)}function getOneReturn(e,t,n){const r=getTheRule(e),i=list(...r);return doRunStream(i,t,n)}function doRunStream(e,t,n){return e?streamAppendStream(e.left(t,n),()=>doRunStream(e.right,t,n)):null}function getDeepType(e){let t="";return e instanceof IPair?t=infixValue(getDeepType(e.left),e.type,getDeepType(e.right)):e instanceof KVar?t="var":t=typeof e,t}function getTheRule(e,t=[]){if(e instanceof IPair){if(e.type==":-")return t.push(toCustomRule(e.left,e.right)),t;if(e.type.startsWith("都")){const n=e.type.slice(1);return toAllRule(t,e.left,n,e.right),t}}return t.push(toCustomRule(e)),t}function toAllRule(e,t,n,r){t instanceof IPair&&t.type==","?(e.unshift(toCustomRule(infixValue(t.right,n,r))),toAllRule(e,t.left,n,r)):e.unshift(toCustomRule(infixValue(t,n,r)))}function ruleGetSymbol(){const[e,t,n]=ruleStrBetweenGet1(35),r=t.content.slice(t.i,n.i);return{type:"symbol",value:e,originalValue:r,begin:t.i,end:n.i}}const refRule=andMatch(orMatch(isLowerEnglish.matchCharBetween(),isUpperEnglish.matchCharBetween(),isChinese.matchCharBetween()),matchCommonExt);function ruleGetRef(){return parseGet(refRule,function(e,t){const n=e.content.slice(e.i,t.i);return{type:"ref",begin:e.i,end:t.i,value:n,messages:[]}},"symbol")}function rGetNumber(){const e=ruleGetNumber();return e.messages=[],e}function rGetStr(){const e=ruleGetString();return e.messages=[],e}const infixLibArray=[[","],{type:"rev",values:["=>"]},{type:"rev",values:["="]},["->"],{type:"rev",values:["<-"]},["+"],["|","&"],{type:"rev",values:[":"]}],{parseSentence,getInfixOrder}=buildInfix(infixLibArray,skipWhiteOrComment,()=>or([rGetStr,ruleGetSymbol,ruleGetRef,rGetNumber]),(e,t,n)=>({type:"infix",infix:e,left:t,right:n,messages:[]}));function unsafeAdd(e){return function(t){const n=t;return n.type=e,n}}const toFillToken=endNotFillToToken(function(e){if(e.type=="string")return{type:"string",value:e.originalValue,begin:e.begin,end:e.end,messages:e.messages};if(e.type=="number")return{type:"number",value:e.originalValue,begin:e.begin,end:e.end,messages:e.messages};if(e.type=="ref")return{type:"variable",value:e.value,begin:e.begin,end:e.end,messages:e.messages};if(e.type=="symbol")return{type:"symbol",value:e.originalValue,begin:e.begin,end:e.end,messages:e.messages};throw new Error("unknown type")},unsafeAdd("keyword"),unsafeAdd("white"));export{getInfixOrder,infixLibArray,parseSentence,refRule,ruleGetRef,ruleGetSymbol,toFillToken};
