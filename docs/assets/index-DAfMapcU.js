import{bI as j,k as V,aj as D,j as W,al as z,b4 as U}from"./index--sZwA4wO.js";import{g as q,r as I,T as F,h as N}from"./hookThreeView-BcSoSFZg.js";import{m as T,l as X,g as Y,a as Z}from"./getBodies-DXZ2fGc1.js";import"./three.module-iyRXV4cU.js";import{cC as J,H as M,j as B,ct as K,cD as Q,a2 as E,a5 as $,cE as ee,f as te,cF as ae,cG as ne,bW as re,S as ie,bu as se,V as _,an as oe,ce,cg as le,cq as he,h as pe,ax as ge,bM as de,ap as me,co as ue}from"./three.core-CVFNDdqD.js";import fe from"./getLayer-BYFYmkp6.js";import"./rad-grad-DAY_59zR.js";const we=""+new URL("san_giuseppe_bridge_2k-DZwWv-1U.jpg",import.meta.url).href,ye=""+new URL("spruit_sunrise_2k.hdr-BSUBzU4I.jpg",import.meta.url).href,Re=Array(1024).fill(0).map((m,e)=>Math.pow(e/255*.9478672986+.0521327014,2.4));class be extends J{constructor(e){super(e),this.type=M}setDataType(e){return this.type=e,this}parse(e,i){const c={version:null,baseRenditionIsHDR:null,gainMapMin:null,gainMapMax:null,gamma:null,offsetSDR:null,offsetHDR:null,hdrCapacityMin:null,hdrCapacityMax:null},h=new TextDecoder,s=new DataView(e);let a=0;const t=[];for(;a<s.byteLength;){const n=s.getUint8(a);if(n===255){const o=s.getUint8(a+1);[216,224,225,226].includes(o)?(t.push({sectionType:o,section:[n,o],sectionOffset:a+2}),a+=2):(t[t.length-1].section.push(n,o),a+=2)}else t[t.length-1].section.push(n),a++}let r,d;for(let n=0;n<t.length;n++){const{sectionType:o,section:p,sectionOffset:g}=t[n];if(o!==224){if(o===225)this._parseXMPMetadata(h.decode(new Uint8Array(p)),c);else if(o===226){const l=new DataView(new Uint8Array(p.slice(2)).buffer);if(l.getUint32(2,!1)===1297106432){const f=l.getUint32(6)===1229531648,w=60,b=l.getUint32(w,f),L=l.getUint32(w+4,f),u=l.getUint32(w+16,f),H=l.getUint32(w+20,f)+g+6;r=new Uint8Array(s.buffer,L,b),d=new Uint8Array(s.buffer,H,u)}}}}if(!c.version)throw new Error("THREE.UltraHDRLoader: Not a valid UltraHDR image");if(r&&d)this._applyGainmapToSDR(c,r,d,(n,o,p)=>{i({width:o,height:p,data:n,format:B,type:this.type})},n=>{throw new Error(n)});else throw new Error("THREE.UltraHDRLoader: Could not parse UltraHDR images")}load(e,i,c,h){const s=new K(this.type===M?new Uint16Array:new Float32Array,0,0,B,this.type,Q,E,E,$,ee,1,te);s.generateMipmaps=!0,s.flipY=!0;const a=new ae(this.manager);return a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setPath(this.path),a.setWithCredentials(this.withCredentials),a.load(e,t=>{try{this.parse(t,r=>{s.image={data:r.data,width:r.width,height:r.height},s.needsUpdate=!0,i&&i(s,r)})}catch(r){h&&h(r),console.error(r)}},c,h),s}_parseXMPMetadata(e,i){const h=new DOMParser().parseFromString(e.substring(e.indexOf("<"),e.lastIndexOf(">")+1),"text/xml"),[s]=h.getElementsByTagName("Container:Directory");if(!s){const[a]=h.getElementsByTagName("rdf:Description");i.version=a.getAttribute("hdrgm:Version"),i.baseRenditionIsHDR=a.getAttribute("hdrgm:BaseRenditionIsHDR")==="True",i.gainMapMin=parseFloat(a.getAttribute("hdrgm:GainMapMin")||0),i.gainMapMax=parseFloat(a.getAttribute("hdrgm:GainMapMax")||1),i.gamma=parseFloat(a.getAttribute("hdrgm:Gamma")||1),i.offsetSDR=parseFloat(a.getAttribute("hdrgm:OffsetSDR")/(1/64)),i.offsetHDR=parseFloat(a.getAttribute("hdrgm:OffsetHDR")/(1/64)),i.hdrCapacityMin=parseFloat(a.getAttribute("hdrgm:HDRCapacityMin")||0),i.hdrCapacityMax=parseFloat(a.getAttribute("hdrgm:HDRCapacityMax")||1)}}_srgbToLinear(e){return e/255<.04045?e/255*.0773993808:e<1024?Re[~~e]:Math.pow(e/255*.9478672986+.0521327014,2.4)}_applyGainmapToSDR(e,i,c,h,s){const a=t=>new Promise((r,d)=>{const n=document.createElement("img");n.onload=()=>{const o={width:n.naturalWidth,height:n.naturalHeight,source:n};URL.revokeObjectURL(n.src),r(o)},n.onerror=()=>{URL.revokeObjectURL(n.src),d()},n.src=URL.createObjectURL(new Blob([t],{type:"image/jpeg"}))});Promise.all([a(i),a(c)]).then(([t,r])=>{const d=t.width/t.height,n=r.width/r.height;if(d!==n){s("THREE.UltraHDRLoader Error: Aspect ratio mismatch between SDR and Gainmap images");return}const o=document.createElement("canvas"),p=o.getContext("2d",{willReadFrequently:!0,colorSpace:"srgb"});o.width=t.width,o.height=t.height,p.drawImage(r.source,0,0,r.width,r.height,0,0,t.width,t.height);const g=p.getImageData(0,0,t.width,t.height,{colorSpace:"srgb"});p.drawImage(t.source,0,0);const l=p.getImageData(0,0,t.width,t.height,{colorSpace:"srgb"});let y;this.type===M?y=new Uint16Array(l.data.length).fill(23544):y=new Float32Array(l.data.length).fill(255);const f=Math.sqrt(Math.pow(1.8,e.hdrCapacityMax)),w=(Math.log2(f)-e.hdrCapacityMin)/(e.hdrCapacityMax-e.hdrCapacityMin),b=Math.min(Math.max(w,0),1),L=e.gamma===1;for(let u=0;u<l.data.length;u+=4){const H=u/4%t.width,P=Math.floor(u/4/t.width);for(let R=0;R<3;R++){const G=l.data[u+R],k=(P*t.width+H)*4+R,A=g.data[k]/255,C=L?A:Math.pow(A,1/e.gamma),x=e.gainMapMin*(1-C)+e.gainMapMax*C,v=(G+e.offsetSDR)*(x*b===0?1:Math.pow(2,x*b))-e.offsetHDR,S=Math.min(Math.max(this._srgbToLinear(v),0),65504);y[u+R]=this.type===M?ne.toHalfFloat(S):S}}h(y,t.width,t.height)}).catch(()=>{throw new Error("THREE.UltraHDRLoader Error: Could not parse UltraHDR images")})}}const O=Object.assign({"./envs/san_giuseppe_bridge_2k.jpg":we,"./envs/spruit_sunrise_2k.hdr.jpg":ye});console.log("envs",O);function Te(){const m=j(Promise.all([T.init(),X()]));V(m.get,function(e){if((e==null?void 0:e.type)=="success"){const i={x:0,y:0,z:0},c=new T.World(i),h=q(D.width,D.height);I({camera:h,width:D.width,height:D.height,args:{antialias:!0},render(s){const{renderer:a,hookAnimationLoop:t}=F.consume();a.toneMapping=re,a.outputColorSpace=ie,N().enableDamping=!0,new be().load(O["./envs/san_giuseppe_bridge_2k.jpg"],g=>{g.mapping=se,s.environment=g});const d=100,n=[];for(let g=0;g<d;g++){const l=Y(c);n.push(l),s.add(l.mesh)}const o=Z(c);s.add(o.mesh);const p=new _(0,0,0);W(z(window,"pointermove",g=>{p.x=g.clientX/window.innerWidth*2-1,p.y=-(g.clientY/window.innerHeight)*2+1})),t(g=>{c.step(),o.update(p),n.forEach(l=>l.update())}),Ue(),De(),Me()}})}})}function De(){const{camera:m,hookAnimationLoop:e}=F.consume(),i=new he,c=new pe(0,0),h=new _(0,0,0),s=new ge(48,48,48,48),a=new de({wireframe:!0,color:65280,transparent:!0,opacity:0}),t=new me(s,a);t.position.set(0,0,.2),U(t);let r=new _;e(()=>{m.getWorldDirection(r),r.multiplyScalar(-1),t.lookAt(r),i.setFromCamera(c,m);const d=i.intersectObjects([t],!1);d.length>0&&h.copy(d[0].point)})}function Me(){const m=new ue(48127,11141375);m.intensity=.2,U(m)}function Ue(){const m=fe({hue:.6,numSprites:8,opacity:.2,radius:10,size:24,z:-10.5});U(m);const e=new oe,i=new ce({size:.035,vertexColors:!0}),c=new le(e,i);U(c)}export{Te as default};
